<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>المعهد الأهلي العالي للتدريب | تدريب الأمن السيبراني</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2r3y9GqX4x3f3j8YwqgVf2b0J3u0y2x0Jm0p6uI=" crossorigin=""/>
  <style>
    body { font-family: "Tahoma", "Segoe UI", Arial, sans-serif; background:#f7f7fb; color:#111; padding:16px; line-height:1.7; }
    h1,h2,h3 { color:#0b6efd; }
    .card { background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); padding:16px; margin-bottom:16px; }
    #map { height: 380px; border-radius:10px; margin-top:12px; }
    button { padding:10px 14px; border-radius:8px; border:0; background:#0b6efd; color:#fff; cursor:pointer; font-weight:600; }
    button[disabled] { background:#9fb8ff; cursor:not-allowed; }
    .warn { color:#b33; font-weight:600; }
    .muted { color:#666; font-size:0.95rem; }
    label { display:flex; gap:8px; align-items:center; }
    header { text-align:center; margin-bottom:20px; }
    header h1 { margin:0; }
    footer { text-align:center; margin-top:20px; font-size:0.9rem; color:#555; }
  </style>
</head>
<body>

  <header>
    <h1>المعهد الأهلي العالي للتدريب</h1>
    <h2>برنامج الأمن السيبراني</h2>
    <h3>عرض تدريبي: مشاركة الموقع الجغرافي</h3>
  </header>

  <div class="card">
    <h3>📌 تعليمات للطلاب</h3>
    <ul>
      <li>الغرض من هذا التمرين هو التدريب على <strong>مفهوم تحديد الموقع</strong> باستخدام تقنيات الويب الحديثة.</li>
      <li>التمرين يتم في بيئة تعليمية آمنة ولا يتم إرسال البيانات إلى أي طرف خارجي.</li>
      <li>المشاركة <strong>طوعية بالكامل</strong>، ويمكنك إيقافها أو رفض الإذن في أي وقت.</li>
      <li>الهدف هو فهم كيفية عمل <strong>Geolocation API</strong> وعرض النتيجة على <strong>خريطة تفاعلية</strong>.</li>
    </ul>
  </div>

  <div class="card">
    <h3>✍️ نموذج الموافقة</h3>
    <form id="consentForm">
      <label>
        <input type="checkbox" id="consentCheckbox" />
        أوافق على المشاركة في هذا التمرين التعليمي الخاص بالأمن السيبراني.
      </label>
      <p class="muted">بعد الموافقة يمكنك الضغط على الزر لطلب الموقع من المتصفح وعرضه على الخريطة.</p>
    </form>
    <div style="margin-top:10px;">
      <button id="getLocBtn" disabled>🚀 طلب الموقع</button>
      <button id="clearBtn" style="background:#6c757d; margin-left:8px;">🔄 إعادة تعيين</button>
    </div>
    <p id="status" class="muted" style="margin-top:8px;"></p>
  </div>

  <div class="card">
    <h3>🌍 النتيجة</h3>
    <p id="info" class="muted">لم يتم طلب الموقع بعد.</p>
    <div id="map" style="display:none;"></div>
  </div>

  <footer>
    © المعهد الأهلي العالي للتدريب – وحدة الأمن السيبراني  
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-QVdVQao6bq3Zl3gF2z2h3j9p1Yh2sd0x5v+f3v9Qm+E=" crossorigin=""></script>
  <script>
    const consentCheckbox = document.getElementById('consentCheckbox');
    const getLocBtn = document.getElementById('getLocBtn');
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    const mapDiv = document.getElementById('map');
    const clearBtn = document.getElementById('clearBtn');

    // تفعيل الزر عند الموافقة
    consentCheckbox.addEventListener('change', () => {
      getLocBtn.disabled = !consentCheckbox.checked;
    });

    // إعادة تعيين
    clearBtn.addEventListener('click', () => {
      consentCheckbox.checked = false;
      getLocBtn.disabled = true;
      statusEl.textContent = '';
      infoEl.textContent = 'لم يتم طلب الموقع بعد.';
      mapDiv.style.display = 'none';
      if (window._demoMap) {
        window._demoMap.remove();
        window._demoMap = null;
      }
    });

    // التحقق من دعم المتصفح
    if (!('geolocation' in navigator)) {
      statusEl.innerHTML = '<span class="warn">⚠️ المتصفح لا يدعم خاصية تحديد الموقع.</span>';
      getLocBtn.disabled = true;
    }

    // طلب الموقع
    getLocBtn.addEventListener('click', () => {
      statusEl.textContent = '⏳ طلب إذن الموقع من المتصفح...';
      infoEl.textContent = 'الرجاء السماح للمتصفح بمشاركة الموقع.';
      navigator.geolocation.getCurrentPosition(onSuccess, onError, {
        enableHighAccuracy: true,
        timeout: 20000,
        maximumAge: 0
      });
    });

    function onSuccess(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      statusEl.textContent = '✅ تم الحصول على الموقع بنجاح.';
      infoEl.innerHTML = `📍 الإحداثيات: <strong>خط العرض</strong> ${lat.toFixed(6)}, <strong>خط الطول</strong> ${lon.toFixed(6)} — بدقة تقريبية ±${Math.round(acc)} متر.`;

      mapDiv.style.display = 'block';
      if (window._demoMap) {
        window._demoMap.remove();
        window._demoMap = null;
      }
      const map = L.map('map').setView([lat, lon], 15);
      window._demoMap = map;
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);
      const marker = L.marker([lat, lon]).addTo(map);
      marker.bindPopup(`📌 موقع الجهاز<br>الدقة ≈ ${Math.round(acc)} م`).openPopup();
    }

    function onError(err) {
      console.warn('Geolocation error:', err);
      switch(err.code) {
        case err.PERMISSION_DENIED:
          statusEl.innerHTML = '<span class="warn">❌ تم رفض الإذن.</span> الرجاء السماح للصفحة بالوصول إلى الموقع.';
          infoEl.textContent = 'الموقع لم يتم الحصول عليه بسبب رفض الإذن.';
          break;
        case err.POSITION_UNAVAILABLE:
          statusEl.innerHTML = '<span class="warn">⚠️ الموقع غير متاح.</span>';
          infoEl.textContent = 'تعذر الحصول على الموقع (غير متاح).';
          break;
        case err.TIMEOUT:
          statusEl.innerHTML = '<span class="warn">⌛ انتهت مهلة الطلب.</span>';
          infoEl.textContent = 'انتهت مهلة الحصول على الموقع. حاول مرة أخرى.';
          break;
        default:
          statusEl.innerHTML = '<span class="warn">⚠️ خطأ غير معروف.</span>';
          infoEl.textContent = 'حدث خطأ أثناء محاولة الحصول على الموقع.';
      }
    }
  </script>
</body>
</html>
