<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>عرض تعليمي: طلب مشاركة الموقع (آمن وبتصريح)</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2r3y9GqX4x3f3j8YwqgVf2b0J3u0y2x0Jm0p6uI=" crossorigin=""/>
  <style>
    body { font-family: system-ui, Arial, "Helvetica Neue", sans-serif; background:#f7f7fb; color:#111; padding:16px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); padding:16px; margin-bottom:12px; }
    #map { height: 360px; border-radius:10px; margin-top:12px; }
    button { padding:10px 14px; border-radius:8px; border:0; background:#0b6efd; color:#fff; cursor:pointer; }
    button[disabled] { background:#9fb8ff; cursor:not-allowed; }
    .warn { color:#b33; font-weight:600; }
    .muted { color:#666; font-size:0.95rem; }
    label { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>

  <h1>عرض تعليمي: مشاركة الموقع (آمن وبتصريح)</h1>

  <div class="card">
    <h3>ملاحظة مهمة (اقرأ قبل المتابعة)</h3>
    <p class="muted">
      هذا العرض تعليمي فقط. لا تقم بتجربة طلب موقع أي شخص دون موافقته الصريحة والموقّعة. هذه الصفحة تطلب الموقع من الجهاز الذي يستخدمها — أي بيانات تُجمع تبقى محليًا في جلسة المتصفح ولا تُرسل لأي طرف آخر.
    </p>
  </div>

  <div class="card">
    <h3>نموذج موافقة سريع (يجب الموافقة لتنفيذ التجربة)</h3>
    <form id="consentForm">
      <label>
        <input type="checkbox" id="consentCheckbox" />
        أوافق طوعًا على إجراء هذه التجربة على جهازي أو بموافقة المشارك الموقّع. أفهم أن المشاركة طوعية ويمكنني الانسحاب في أي وقت.
      </label>
      <p class="muted">انقر الموافقة ثم اضغط "طلب الموقع" لعرض الموقع على الخريطة (إذا منحت المتصفح الإذن).</p>
    </form>
    <div style="margin-top:10px;">
      <button id="getLocBtn" disabled>طلب الموقع الآن</button>
      <button id="clearBtn" style="background:#6c757d; margin-left:8px;">إعادة تعيين</button>
    </div>
    <p id="status" class="muted" style="margin-top:8px;"></p>
  </div>

  <div class="card">
    <h3>النتيجة</h3>
    <div id="info" class="muted">لم يطْلب الموقع بعد.</div>
    <div id="map" style="display:none;"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-QVdVQao6bq3Zl3gF2z2h3j9p1Yh2sd0x5v+f3v9Qm+E=" crossorigin=""></script>
  <script>
    // عناصر DOM
    const consentCheckbox = document.getElementById('consentCheckbox');
    const getLocBtn = document.getElementById('getLocBtn');
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    const mapDiv = document.getElementById('map');
    const clearBtn = document.getElementById('clearBtn');

    // تفعيل الزر عند الموافقة
    consentCheckbox.addEventListener('change', () => {
      getLocBtn.disabled = !consentCheckbox.checked;
    });

    // إعادة تعيين
    clearBtn.addEventListener('click', () => {
      consentCheckbox.checked = false;
      getLocBtn.disabled = true;
      statusEl.textContent = '';
      infoEl.textContent = 'لم يطْلب الموقع بعد.';
      mapDiv.style.display = 'none';
      if (window._demoMap) {
        window._demoMap.remove();
        window._demoMap = null;
      }
    });

    // التحقق من دعم المتصفح
    if (!('geolocation' in navigator)) {
      statusEl.innerHTML = '<span class="warn">تنبيه:</span> المتصفح لا يدعم Geolocation.';
      getLocBtn.disabled = true;
    }

    // وظيفة الحصول على الموقع
    getLocBtn.addEventListener('click', () => {
      statusEl.textContent = 'طلب إذن الموقع من المتصفح...';
      infoEl.textContent = 'انتظر إذن المتصفح ثم تحقق من النتيجة.';
      // نستخدم getCurrentPosition مع إعدادات ملائمة
      navigator.geolocation.getCurrentPosition(onSuccess, onError, {
        enableHighAccuracy: true,
        timeout: 20000,
        maximumAge: 0
      });
    });

    function onSuccess(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      statusEl.textContent = 'الموقع تم الحصول عليه بنجاح.';
      infoEl.innerHTML = `الإحداثيات: <strong>خط العرض</strong> ${lat.toFixed(6)}, <strong>خط الطول</strong> ${lon.toFixed(6)} — تقريبًا ±${Math.round(acc)} متر.`;

      // عرض الخريطة باستخدام Leaflet
      mapDiv.style.display = 'block';
      // إذا كانت الخريطة موجودة من قبل نزيلها ثم نعيد إنشاءها (لتجربة متكررة)
      if (window._demoMap) {
        window._demoMap.remove();
        window._demoMap = null;
      }
      const map = L.map('map').setView([lat, lon], 15);
      window._demoMap = map;
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);
      const marker = L.marker([lat, lon]).addTo(map);
      marker.bindPopup(`موقع الجهاز<br>دقة ≈ ${Math.round(acc)} م`).openPopup();
    }

    function onError(err) {
      console.warn('Geolocation error:', err);
      switch(err.code) {
        case err.PERMISSION_DENIED:
          statusEl.innerHTML = '<span class="warn">تم رفض الإذن.</span> تأكد من منح الموقع للصفحة أو اختر "السماح".';
          infoEl.textContent = 'لم يتم الحصول على الموقع لأن الإذن رُفض.';
          break;
        case err.POSITION_UNAVAILABLE:
          statusEl.innerHTML = '<span class="warn">الموقع غير متاح.</span>';
          infoEl.textContent = 'تعذر الحصول على الموقع (غير متاح).';
          break;
        case err.TIMEOUT:
          statusEl.innerHTML = '<span class="warn">انتهى مهلة الطلب.</span>';
          infoEl.textContent = 'انتهت مهلة الحصول على الموقع. جرّب مرة أخرى أو تحقق من إعدادات الجهاز.';
          break;
        default:
          statusEl.innerHTML = '<span class="warn">خطأ غير معروف.</span>';
          infoEl.textContent = 'حدث خطأ أثناء محاولة الحصول على الموقع.';
      }
    }
  </script>
</body>
</html>
